generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Organization {
  id                  String               @id @default(cuid())
  name                String
  slug                String               @unique
  logo                String?
  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @updatedAt @map("updated_at")
  settings            Json                 @default("{}")
  capabilities        Json                 @default("{\"core_parts\": true}")
  plan                String               @default("free")
  planExpiry          DateTime?            @map("plan_expiry")
  branding            Json?                @default("{}")
  auditLogs           AuditLog[]
  clientTemplates     ClientTemplate[]
  cutlists            Cutlist[]
  edgebands           Edgeband[]
  invitations         Invitation[]
  materialMappings    MaterialMapping[]
  materials           Material[]
  parseCorrections    ParseCorrection[]
  parseJobs           ParseJob[]
  parserPatterns      ParserPattern[]
  parsingAccuracyLogs ParsingAccuracyLog[]
  templates           Template[]
  trainingExamples    TrainingExample[]
  files               UploadedFile[]
  users               User[]

  @@map("organizations")
}

model User {
  id               String            @id @default(cuid())
  email            String            @unique
  name             String?
  avatar           String?
  phone            String?
  jobTitle         String?           @map("job_title")
  passwordHash     String?           @map("password_hash")
  emailVerified    DateTime?         @map("email_verified")
  lastLoginAt      DateTime?         @map("last_login_at")
  isActive         Boolean           @default(true) @map("is_active")
  isSuperAdmin     Boolean           @default(false) @map("is_super_admin")
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")
  preferences      Json              @default("{}")
  notifications    Json              @default("{\"push\": true, \"email\": true}")
  organizationId   String?           @map("organization_id")
  roleId           String?           @map("role_id")
  auditLogs        AuditLog[]
  cutlists         Cutlist[]
  invitationsSent  Invitation[]      @relation("InvitedBy")
  parseCorrections ParseCorrection[]
  parseJobs        ParseJob[]
  sessions         Session[]
  organization     Organization?     @relation(fields: [organizationId], references: [id])
  role             Role?             @relation(fields: [roleId], references: [id])

  @@index([organizationId])
  @@index([roleId])
  @@index([lastLoginAt(sort: Desc)])
  @@map("users")
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  displayName String   @map("display_name")
  description String?
  isSystem    Boolean  @default(false) @map("is_system")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  permissions Json     @default("{}")
  users       User[]

  @@map("roles")
}

model Invitation {
  id             String       @id @default(cuid())
  email          String
  token          String       @unique
  roleId         String       @map("role_id")
  expiresAt      DateTime     @map("expires_at")
  acceptedAt     DateTime?    @map("accepted_at")
  createdAt      DateTime     @default(now()) @map("created_at")
  organizationId String       @map("organization_id")
  invitedById    String       @map("invited_by_id")
  invitedBy      User         @relation("InvitedBy", fields: [invitedById], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([token])
  @@map("invitations")
}

model Session {
  id           String   @id @default(cuid())
  token        String   @unique
  userAgent    String?  @map("user_agent")
  ipAddress    String?  @map("ip_address")
  expiresAt    DateTime @map("expires_at")
  lastActiveAt DateTime @default(now()) @map("last_active_at")
  createdAt    DateTime @default(now()) @map("created_at")
  userId       String   @map("user_id")
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("sessions")
}

model AuditLog {
  id             String        @id @default(cuid())
  action         String
  entityType     String?       @map("entity_type")
  entityId       String?       @map("entity_id")
  metadata       Json?
  ipAddress      String?       @map("ip_address")
  userAgent      String?       @map("user_agent")
  createdAt      DateTime      @default(now()) @map("created_at")
  userId         String?       @map("user_id")
  organizationId String?       @map("organization_id")
  organization   Organization? @relation(fields: [organizationId], references: [id])
  user           User?         @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([organizationId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

model PlatformSettings {
  id        String   @id @default("platform")
  settings  Json     @default("{}")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("platform_settings")
}

model Material {
  id             String       @id @default(cuid())
  materialId     String       @map("material_id")
  name           String
  sku            String?
  thicknessMm    Float        @map("thickness_mm")
  coreType       String?      @map("core_type")
  finish         String?
  colorCode      String?      @map("color_code")
  defaultSheet   Json?        @map("default_sheet")
  meta           Json?
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  organizationId String       @map("organization_id")
  grain          String?      @default("none")
  supplier       String?
  parts          CutPart[]
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, materialId])
  @@map("materials")
}

model Edgeband {
  id                   String       @id @default(cuid())
  edgebandId           String       @map("edgeband_id")
  name                 String
  thicknessMm          Float        @map("thickness_mm")
  colorMatchMaterialId String?      @map("color_match_material_id")
  finish               String?
  meta                 Json?
  createdAt            DateTime     @default(now()) @map("created_at")
  updatedAt            DateTime     @updatedAt @map("updated_at")
  organizationId       String       @map("organization_id")
  color_code           String?
  waste_factor_pct     Decimal?     @default(1) @db.Decimal
  overhang_mm          Decimal?     @default(0) @db.Decimal
  supplier             String?
  organization         Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, edgebandId])
  @@map("edgebands")
}

model Cutlist {
  id             String         @id @default(cuid())
  docId          String         @map("doc_id")
  schemaVersion  String         @default("cai-cutlist/v1") @map("schema_version")
  name           String?
  jobId          String?        @map("job_id")
  status         String         @default("draft")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")
  sourceMethod   String         @map("source_method")
  sourceClient   String?        @map("source_client")
  sourceFileRef  String?        @map("source_file_ref")
  sourceTemplate String?        @map("source_template")
  capabilities   Json           @default("{\"core_parts\": true}")
  meta           Json?
  cncLibrary     Json?          @map("cnc_library")
  organizationId String         @map("organization_id")
  userId         String?        @map("user_id")
  project_name   String?        @db.VarChar(255)
  customer_name  String?        @db.VarChar(255)
  parts          CutPart[]
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User?          @relation(fields: [userId], references: [id])
  exports        Export[]
  optimizeJobs   OptimizeJob[]
  parseJobs      ParseJob[]
  sourceFiles    UploadedFile[]

  @@unique([organizationId, docId])
  @@index([organizationId])
  @@index([userId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@index([organizationId, createdAt(sort: Desc)])
  @@index([customer_name], map: "idx_cutlists_customer_name")
  @@index([project_name], map: "idx_cutlists_project_name")
  @@map("cutlists")
}

model CutPart {
  id            String    @id @default(cuid())
  partId        String    @map("part_id")
  label         String?
  family        String?
  qty           Int
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  sizeL         Float     @map("size_l")
  sizeW         Float     @map("size_w")
  thicknessMm   Float     @map("thickness_mm")
  materialRef   String    @map("material_ref")
  grain         String    @default("none")
  allowRotation Boolean   @default(true) @map("allow_rotation")
  groupId       String?   @map("group_id")
  subGroup      String?   @map("sub_group")
  priority      Int?
  tags          String[]  @default([])
  ops           Json?
  notes         Json?
  audit         Json?
  cutlistId     String    @map("cutlist_id")
  materialId    String?   @map("material_id")
  cutlist       Cutlist   @relation(fields: [cutlistId], references: [id], onDelete: Cascade)
  material      Material? @relation(fields: [materialId], references: [id])

  @@unique([cutlistId, partId])
  @@index([cutlistId])
  @@index([materialRef])
  @@map("cut_parts")
}

model ParseJob {
  id               String            @id @default(cuid())
  status           String            @default("queued")
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")
  completedAt      DateTime?         @map("completed_at")
  sourceKind       String            @map("source_kind")
  sourceData       Json              @map("source_data")
  options          Json?
  mapping          Json?
  partsPreview     Json?             @map("parts_preview")
  summary          Json?
  organizationId   String            @map("organization_id")
  userId           String?           @map("user_id")
  cutlistId        String?           @map("cutlist_id")
  fileId           String?           @map("file_id")
  parseCorrections ParseCorrection[]
  cutlist          Cutlist?          @relation(fields: [cutlistId], references: [id])
  file             UploadedFile?     @relation(fields: [fileId], references: [id])
  organization     Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user             User?             @relation(fields: [userId], references: [id])

  @@index([organizationId])
  @@index([status])
  @@map("parse_jobs")
}

model UploadedFile {
  id             String       @id @default(cuid())
  fileName       String       @map("file_name")
  originalName   String       @map("original_name")
  mimeType       String       @map("mime_type")
  sizeBytes      Int          @map("size_bytes")
  storagePath    String       @map("storage_path")
  createdAt      DateTime     @default(now()) @map("created_at")
  kind           String       @default("cutlist_source")
  organizationId String       @map("organization_id")
  cutlistId      String?      @map("cutlist_id")
  parseJobs      ParseJob[]
  cutlist        Cutlist?     @relation(fields: [cutlistId], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([createdAt(sort: Desc)])
  @@index([organizationId, createdAt(sort: Desc)])
  @@index([cutlistId], map: "idx_uploaded_files_cutlist_id")
  @@index([organizationId], map: "idx_uploaded_files_organization_id")
  @@map("uploaded_files")
}

model OptimizeJob {
  id            String    @id @default(cuid())
  status        String    @default("queued")
  engine        String    @default("cai2d_guillotine")
  engineVersion String?   @map("engine_version")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  completedAt   DateTime? @map("completed_at")
  options       Json?
  metrics       Json?
  result        Json?
  cutlistId     String    @map("cutlist_id")
  cutlist       Cutlist   @relation(fields: [cutlistId], references: [id], onDelete: Cascade)

  @@index([cutlistId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@index([status, cutlistId])
  @@map("optimize_jobs")
}

model Export {
  id          String    @id @default(cuid())
  format      String
  status      String    @default("completed")
  downloadUrl String?   @map("download_url")
  expiresAt   DateTime? @map("expires_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  options     Json?
  cutlistId   String    @map("cutlist_id")
  cutlist     Cutlist   @relation(fields: [cutlistId], references: [id], onDelete: Cascade)

  @@index([cutlistId])
  @@map("exports")
}

model Template {
  id             String       @id @default(cuid())
  templateId     String       @map("template_id")
  name           String
  kind           String
  version        Int          @default(1)
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  capabilities   Json         @default("{\"core_parts\": true}")
  layoutConfig   Json?        @map("layout_config")
  fileUrl        String?      @map("file_url")
  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, templateId])
  @@map("templates")
}

model ParserPattern {
  id             String        @id @default(cuid())
  organizationId String?       @map("organization_id")
  patternType    String        @map("pattern_type")
  inputPattern   String        @map("input_pattern")
  outputMapping  Json          @map("output_mapping")
  description    String?
  confidence     Float         @default(0.5)
  usageCount     Int           @default(0) @map("usage_count")
  successCount   Int           @default(0) @map("success_count")
  lastUsedAt     DateTime?     @map("last_used_at")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([confidence(sort: Desc)], map: "idx_parser_patterns_confidence")
  @@index([organizationId], map: "idx_parser_patterns_org")
  @@index([patternType], map: "idx_parser_patterns_type")
  @@map("parser_patterns")
}

model MaterialMapping {
  id             String        @id @default(cuid())
  organizationId String?       @map("organization_id")
  rawName        String        @map("raw_name")
  normalizedName String        @map("normalized_name")
  materialId     String        @map("material_id")
  thicknessMm    Float?        @map("thickness_mm")
  confidence     Float         @default(0.5)
  usageCount     Int           @default(0) @map("usage_count")
  lastUsedAt     DateTime?     @map("last_used_at")
  createdAt      DateTime      @default(now()) @map("created_at")
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, normalizedName])
  @@index([normalizedName], map: "idx_material_mappings_normalized")
  @@index([organizationId], map: "idx_material_mappings_org")
  @@map("material_mappings")
}

model ClientTemplate {
  id                 String        @id @default(cuid())
  organizationId     String?       @map("organization_id")
  clientName         String        @map("client_name")
  clientAliases      String[]      @default([]) @map("client_aliases")
  columnOrder        String[]      @map("column_order")
  edgeNotation       Json?         @map("edge_notation")
  grooveNotation     Json?         @map("groove_notation")
  defaultMaterialId  String?       @map("default_material_id")
  defaultThicknessMm Float?        @map("default_thickness_mm")
  headerPatterns     String[]      @default([]) @map("header_patterns")
  sampleRows         Json?         @map("sample_rows")
  notes              String?
  confidence         Float         @default(0.5)
  usageCount         Int           @default(0) @map("usage_count")
  successRate        Float         @default(0.5) @map("success_rate")
  lastUsedAt         DateTime?     @map("last_used_at")
  createdAt          DateTime      @default(now()) @map("created_at")
  updatedAt          DateTime      @updatedAt @map("updated_at")
  organization       Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([clientName], map: "idx_client_templates_name")
  @@index([organizationId], map: "idx_client_templates_org")
  @@map("client_templates")
}

model ParseCorrection {
  id               String        @id @default(cuid())
  organizationId   String?       @map("organization_id")
  userId           String?       @map("user_id")
  parseJobId       String?       @map("parse_job_id")
  cutlistId        String?       @map("cutlist_id")
  correctionType   String        @map("correction_type")
  fieldPath        String?       @map("field_path")
  originalValue    Json?         @map("original_value")
  correctedValue   Json?         @map("corrected_value")
  originalPart     Json?         @map("original_part")
  correctedPart    Json?         @map("corrected_part")
  sourceText       String?       @map("source_text")
  sourceLineNumber Int?          @map("source_line_number")
  sourceFileName   String?       @map("source_file_name")
  patternExtracted Boolean       @default(false) @map("pattern_extracted")
  patternId        String?       @map("pattern_id")
  createdAt        DateTime      @default(now()) @map("created_at")
  organization     Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  parseJob         ParseJob?     @relation(fields: [parseJobId], references: [id])
  user             User?         @relation(fields: [userId], references: [id])

  @@index([createdAt(sort: Desc)], map: "idx_parse_corrections_created")
  @@index([organizationId], map: "idx_parse_corrections_org")
  @@index([correctionType], map: "idx_parse_corrections_type")
  @@index([userId], map: "idx_parse_corrections_user")
  @@map("parse_corrections")
}

model OcrJob {
  id               String    @id @default(cuid())
  organizationId   String?   @map("organization_id")
  userId           String?   @map("user_id")
  fileId           String?   @map("file_id")
  cutlistId        String?   @map("cutlist_id")
  filename         String
  fileType         String?   @map("file_type")
  fileSizeBytes    BigInt?   @map("file_size_bytes")
  storagePath      String?   @map("storage_path")
  totalPages       Int       @default(1) @map("total_pages")
  currentPage      Int       @default(0) @map("current_page")
  pagesProcessed   Int       @default(0) @map("pages_processed")
  progressPercent  Int       @default(0) @map("progress_percent")
  stage            String?
  extractedText    String?   @map("extracted_text")
  detectedFormat   String?   @map("detected_format")
  partsCount       Int       @default(0) @map("parts_count")
  confidence       Float?
  clientTemplateId String?   @map("client_template_id")
  learningApplied  Boolean   @default(false) @map("learning_applied")
  startedAt        DateTime? @map("started_at")
  completedAt      DateTime? @map("completed_at")
  processingTimeMs Int?      @map("processing_time_ms")
  errorMessage     String?   @map("error_message")
  retryCount       Int       @default(0) @map("retry_count")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  provider         String    @default("openai")
  status           String    @default("queued")

  @@index([status])
  @@index([createdAt(sort: Desc)], map: "idx_ocr_jobs_created")
  @@index([organizationId], map: "idx_ocr_jobs_org")
  @@index([userId], map: "idx_ocr_jobs_user")
  @@map("ocr_jobs")
}

model OcrPageResult {
  id               String   @id @default(cuid())
  ocrJobId         String   @map("ocr_job_id")
  pageNumber       Int      @map("page_number")
  extractedText    String?  @map("extracted_text")
  confidence       Float?
  partsCount       Int      @default(0) @map("parts_count")
  partsData        Json?    @map("parts_data")
  processingTimeMs Int?     @map("processing_time_ms")
  createdAt        DateTime @default(now()) @map("created_at")

  @@unique([ocrJobId, pageNumber])
  @@index([ocrJobId], map: "idx_ocr_page_results_job")
  @@map("ocr_page_results")
}

model HolePattern {
  id               String   @id @default(cuid())
  organizationId   String   @map("organization_id")
  patternId        String   @map("pattern_id")
  name             String
  description      String?
  kind             String
  holes            Json     @default("[]")
  refEdge          String?  @map("ref_edge")
  refCorner        String?  @map("ref_corner")
  parametricConfig Json?    @map("parametric_config")
  hardwareId       String?  @map("hardware_id")
  hardwareBrand    String?  @map("hardware_brand")
  hardwareModel    String?  @map("hardware_model")
  isSystem         Boolean  @default(false) @map("is_system")
  isActive         Boolean  @default(true) @map("is_active")
  usageCount       Int      @default(0) @map("usage_count")
  metadata         Json?
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@unique([organizationId, patternId], map: "hole_patterns_org_pattern_unique")
  @@index([organizationId])
  @@index([kind])
  @@index([usageCount(sort: Desc)])
  @@map("hole_patterns")
}

model GrooveProfile {
  id                   String   @id @default(cuid())
  organizationId       String   @map("organization_id")
  profileId            String   @map("profile_id")
  name                 String
  description          String?
  widthMm              Float    @map("width_mm")
  depthMm              Float    @map("depth_mm")
  purpose              String?
  defaultOffsetMm      Float?   @default(10) @map("default_offset_mm")
  defaultFace          String?  @default("back") @map("default_face")
  allowStopped         Boolean  @default(true) @map("allow_stopped")
  defaultStartOffsetMm Float?   @default(0) @map("default_start_offset_mm")
  defaultEndOffsetMm   Float?   @default(0) @map("default_end_offset_mm")
  toolDiaMm            Float?   @map("tool_dia_mm")
  toolId               String?  @map("tool_id")
  feedRate             Int?     @map("feed_rate")
  isSystem             Boolean  @default(false) @map("is_system")
  isActive             Boolean  @default(true) @map("is_active")
  usageCount           Int      @default(0) @map("usage_count")
  metadata             Json?
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  @@unique([organizationId, profileId], map: "groove_profiles_org_profile_unique")
  @@index([organizationId])
  @@index([purpose])
  @@index([usageCount(sort: Desc)])
  @@map("groove_profiles")
}

model RoutingProfile {
  id             String   @id @default(cuid())
  organizationId String   @map("organization_id")
  profileId      String   @map("profile_id")
  name           String
  description    String?
  profileType    String   @map("profile_type")
  specifications Json     @default("{}")
  toolDiaMm      Float?   @map("tool_dia_mm")
  toolId         String?  @map("tool_id")
  toolType       String?  @map("tool_type")
  feedRate       Int?     @map("feed_rate")
  plungeRate     Int?     @map("plunge_rate")
  spindleSpeed   Int?     @map("spindle_speed")
  stepDownMm     Float?   @map("step_down_mm")
  dxfLayer       String?  @map("dxf_layer")
  gcodeTemplate  String?  @map("gcode_template")
  isSystem       Boolean  @default(false) @map("is_system")
  isActive       Boolean  @default(true) @map("is_active")
  usageCount     Int      @default(0) @map("usage_count")
  metadata       Json?
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@unique([organizationId, profileId], map: "routing_profiles_org_profile_unique")
  @@index([organizationId])
  @@index([profileType])
  @@index([usageCount(sort: Desc)])
  @@map("routing_profiles")
}

model OperationType {
  id             String   @id @default(cuid())
  organizationId String?  @map("organization_id")
  category       String
  code           String
  name           String
  description    String?
  isSystem       Boolean  @default(false) @map("is_system")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @default(now()) @map("updated_at")
  displayOrder   Int      @default(0) @map("display_order")
  icon           String?
  isActive       Boolean  @default(true) @map("is_active")

  @@unique([organizationId, category, code], map: "idx_operation_types_org_cat_code")
  @@index([category], map: "idx_operation_types_category")
  @@index([organizationId], map: "idx_operation_types_org")
  @@map("operation_types")
}

model EdgebandOperation {
  id             String   @id @default(cuid())
  organizationId String?  @map("organization_id")
  code           String
  name           String
  description    String?
  edges          String[] @default([])
  thicknessMm    Float?   @map("thickness_mm")
  materialId     String?  @map("material_id")
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @default(now()) @map("updated_at")
  usageCount     Int      @default(0) @map("usage_count")

  @@unique([organizationId, code], map: "idx_edgeband_operations_org_code")
  @@index([organizationId], map: "idx_edgeband_operations_org")
  @@map("edgeband_operations")
}

model GrooveOperation {
  id               String   @id @default(cuid())
  organizationId   String?  @map("organization_id")
  typeId           String?  @map("type_id")
  code             String
  name             String
  description      String?
  widthMm          Float    @map("width_mm")
  depthMm          Float    @map("depth_mm")
  offsetFromEdgeMm Float    @default(0) @map("offset_from_edge_mm")
  edge             String?
  isActive         Boolean  @default(true) @map("is_active")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @default(now()) @map("updated_at")
  usageCount       Int      @default(0) @map("usage_count")

  @@unique([organizationId, code], map: "idx_groove_operations_org_code")
  @@index([organizationId], map: "idx_groove_operations_org")
  @@map("groove_operations")
}

model DrillingOperation {
  id             String   @id @default(cuid())
  organizationId String?  @map("organization_id")
  typeId         String?  @map("type_id")
  code           String
  name           String
  description    String?
  holes          Json     @default("[]")
  refEdge        String?  @map("ref_edge")
  refCorner      String?  @map("ref_corner")
  hardwareBrand  String?  @map("hardware_brand")
  hardwareModel  String?  @map("hardware_model")
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @default(now()) @map("updated_at")
  usageCount     Int      @default(0) @map("usage_count")

  @@unique([organizationId, code], map: "idx_drilling_operations_org_code")
  @@index([organizationId], map: "idx_drilling_operations_org")
  @@map("drilling_operations")
}

model CncOperation {
  id               String   @id @default(cuid())
  organizationId   String?  @map("organization_id")
  typeId           String?  @map("type_id")
  code             String
  name             String
  description      String?
  opType           String   @map("op_type")
  parametricConfig Json?    @map("parametric_config")
  shapeId          String?  @map("shape_id")
  params           Json?
  isActive         Boolean  @default(true) @map("is_active")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @default(now()) @map("updated_at")
  usageCount       Int      @default(0) @map("usage_count")

  @@unique([organizationId, code], map: "idx_cnc_operations_org_code")
  @@index([organizationId], map: "idx_cnc_operations_org")
  @@map("cnc_operations")
}

model Plan {
  id                   String   @id
  name                 String
  description          String?
  priceMonthly         Int      @default(0) @map("price_monthly_cents")
  priceYearly          Int      @default(0) @map("price_yearly_cents")
  currency             String   @default("USD")
  stripeProductId      String?  @map("stripe_product_id")
  stripePriceIdMonthly String?  @map("stripe_price_id_monthly")
  stripePriceIdYearly  String?  @map("stripe_price_id_yearly")
  limits               Json     @default("{}")
  badge                String?
  highlighted          Boolean  @default(false)
  displayOrder         Int      @default(0) @map("display_order")
  isActive             Boolean  @default(true) @map("is_active")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  @@map("plans")
}

model Subscription {
  id                   String    @id @default(cuid())
  status               String    @default("active")
  billingInterval      String    @default("monthly") @map("billing_interval")
  currentPeriodStart   DateTime? @map("current_period_start")
  currentPeriodEnd     DateTime? @map("current_period_end")
  trialStart           DateTime? @map("trial_start")
  trialEnd             DateTime? @map("trial_end")
  cancelAtPeriodEnd    Boolean   @default(false) @map("cancel_at_period_end")
  canceledAt           DateTime? @map("canceled_at")
  endedAt              DateTime? @map("ended_at")
  stripeCustomerId     String?   @unique @map("stripe_customer_id")
  stripeSubscriptionId String?   @unique @map("stripe_subscription_id")
  metadata             Json      @default("{}")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")
  organizationId       String    @unique @map("organization_id")
  planId               String    @map("plan_id")

  @@index([status])
  @@map("subscriptions")
}

model SubscriptionUsage {
  id               String   @id @default(cuid())
  periodStart      DateTime @map("period_start")
  periodEnd        DateTime @map("period_end")
  cutlistsCreated  Int      @default(0) @map("cutlists_created")
  partsProcessed   Int      @default(0) @map("parts_processed")
  aiParsesUsed     Int      @default(0) @map("ai_parses_used")
  ocrPagesUsed     Int      @default(0) @map("ocr_pages_used")
  optimizationsRun Int      @default(0) @map("optimizations_run")
  storageUsedMb    Float    @default(0) @map("storage_used_mb")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")
  organizationId   String   @map("organization_id")

  @@unique([organizationId, periodStart])
  @@index([organizationId])
  @@map("subscription_usage")
}

model PaymentMethod {
  id                    String   @id @default(cuid())
  stripePaymentMethodId String   @unique @map("stripe_payment_method_id")
  type                  String
  cardBrand             String?  @map("card_brand")
  cardLast4             String?  @map("card_last4")
  cardExpMonth          Int?     @map("card_exp_month")
  cardExpYear           Int?     @map("card_exp_year")
  isDefault             Boolean  @default(false) @map("is_default")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")
  organizationId        String   @map("organization_id")

  @@index([organizationId])
  @@map("payment_methods")
}

model Invoice {
  id               String    @id @default(cuid())
  stripeInvoiceId  String?   @unique @map("stripe_invoice_id")
  invoiceNumber    String?   @map("invoice_number")
  subtotalCents    Int       @default(0) @map("subtotal_cents")
  taxCents         Int       @default(0) @map("tax_cents")
  totalCents       Int       @default(0) @map("total_cents")
  amountPaidCents  Int       @default(0) @map("amount_paid_cents")
  amountDueCents   Int       @default(0) @map("amount_due_cents")
  currency         String    @default("USD")
  status           String
  hostedInvoiceUrl String?   @map("hosted_invoice_url")
  invoicePdfUrl    String?   @map("invoice_pdf_url")
  periodStart      DateTime? @map("period_start")
  periodEnd        DateTime? @map("period_end")
  dueDate          DateTime? @map("due_date")
  paidAt           DateTime? @map("paid_at")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  organizationId   String    @map("organization_id")
  subscriptionId   String?   @map("subscription_id")

  @@index([organizationId])
  @@index([status])
  @@map("invoices")
}

model FeatureOverride {
  id             String    @id @default(cuid())
  featureKey     String    @map("feature_key")
  overrideValue  Json      @map("override_value")
  reason         String?
  expiresAt      DateTime? @map("expires_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  organizationId String    @map("organization_id")
  createdById    String?   @map("created_by")

  @@unique([organizationId, featureKey])
  @@index([organizationId])
  @@map("feature_overrides")
}

/// Training examples with verified correct output for few-shot learning
model TrainingExample {
  id                String        @id @default(cuid())
  sourceType        String        @map("source_type")
  sourceText        String        @map("source_text")
  sourceFileName    String?       @map("source_file_name")
  sourceFileHash    String?       @map("source_file_hash")
  correctParts      Json          @map("correct_parts")
  correctMetadata   Json?         @map("correct_metadata")
  category          String?
  difficulty        String        @default("medium")
  clientName        String?       @map("client_name")
  hasHeaders        Boolean       @default(true) @map("has_headers")
  columnCount       Int?          @map("column_count")
  rowCount          Int?          @map("row_count")
  hasEdgeNotation   Boolean       @default(false) @map("has_edge_notation")
  hasGrooveNotation Boolean       @default(false) @map("has_groove_notation")
  usageCount        Int           @default(0) @map("usage_count")
  successCount      Int           @default(0) @map("success_count")
  lastUsedAt        DateTime?     @map("last_used_at")
  isActive          Boolean       @default(true) @map("is_active")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  createdById       String?       @map("created_by")
  organizationId    String?       @map("organization_id")
  organization      Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([category])
  @@index([clientName])
  @@index([difficulty])
  @@index([sourceFileHash])
  @@index([successCount(sort: Desc)])
  @@map("training_examples")
}

/// Track parsing accuracy over time for analytics and improvement
model ParsingAccuracyLog {
  id                  String        @id @default(cuid())
  parseJobId          String?       @map("parse_job_id")
  provider            String
  sourceType          String?       @map("source_type")
  totalParts          Int           @map("total_parts")
  correctParts        Int           @map("correct_parts")
  accuracy            Float
  dimensionAccuracy   Float?        @map("dimension_accuracy")
  materialAccuracy    Float?        @map("material_accuracy")
  edgingAccuracy      Float?        @map("edging_accuracy")
  groovingAccuracy    Float?        @map("grooving_accuracy")
  quantityAccuracy    Float?        @map("quantity_accuracy")
  labelAccuracy       Float?        @map("label_accuracy")
  fewShotExamplesUsed Int           @default(0) @map("few_shot_examples_used")
  patternsApplied     Int           @default(0) @map("patterns_applied")
  clientTemplateUsed  Boolean       @default(false) @map("client_template_used")
  documentDifficulty  String?       @map("document_difficulty")
  clientName          String?       @map("client_name")
  createdAt           DateTime      @default(now()) @map("created_at")
  organizationId      String?       @map("organization_id")
  organization        Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([provider])
  @@index([accuracy])
  @@index([createdAt(sort: Desc)])
  @@index([organizationId, createdAt], map: "parsing_accuracy_logs_org_created_idx")
  @@map("parsing_accuracy_logs")
}
